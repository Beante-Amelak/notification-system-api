<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:http="http://www.mulesoft.org/schema/mule/http"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
        http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
        http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <munit:config name="document-service-error-test.xml"/>

    <!-- =========================================================
         Test: Document Service Error - Connectivity Failure
         Verifies HTTP 500 when document service is unavailable
         ========================================================= -->
    <munit:test name="document-service-connectivity-error-test" 
                description="Test document service connectivity error - HTTP 500"
                expectedErrorType="APP:DOCUMENT_SERVICE_ERROR">
        
        <!-- Behavior: Mock document service to return connectivity error -->
        <munit:behavior>
            
            <!-- Mock Document Service to return error -->
            <munit-tools:mock-when doc:name="Mock Document Service Error" processor="http:request">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Call Document Service" attributeName="doc:name"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:error typeId="HTTP:CONNECTIVITY"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
        </munit:behavior>
        
        <!-- Execution -->
        <munit:execution>
            
            <!-- Set input event with valid request -->
            <munit:set-event doc:name="Set Valid Notification Request">
                <munit:payload value="#[MunitTools::getResourceAsString('sample-data/notification-request.json')]" mediaType="application/json" encoding="UTF-8"/>
                <munit:attributes value="#[{
                    headers: {
                        'client_id': p('secure::api.clientId'),
                        'client_secret': p('secure::api.clientSecret'),
                        'content-type': 'application/json'
                    },
                    method: 'POST',
                    requestPath: '/api/v1/notifications'
                }]"/>
                <munit:variables>
                    <munit:variable key="correlationId" value="#[uuid()]"/>
                </munit:variables>
            </munit:set-event>
            
            <!-- Call the implementation flow -->
            <flow-ref doc:name="Call POST Notifications Flow" name="post:\notifications:application\json:notification-system-api-config"/>
            
        </munit:execution>
        
    </munit:test>

    <!-- =========================================================
         Test: Document Service Error - Timeout
         Verifies HTTP 500 when document service times out
         ========================================================= -->
    <munit:test name="document-service-timeout-error-test" 
                description="Test document service timeout error - HTTP 500"
                expectedErrorType="APP:DOCUMENT_SERVICE_ERROR">
        
        <!-- Behavior: Mock document service to return timeout error -->
        <munit:behavior>
            
            <!-- Mock Document Service to return timeout -->
            <munit-tools:mock-when doc:name="Mock Document Service Timeout" processor="http:request">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Call Document Service" attributeName="doc:name"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:error typeId="HTTP:TIMEOUT"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
        </munit:behavior>
        
        <!-- Execution -->
        <munit:execution>
            
            <!-- Set input event with valid request -->
            <munit:set-event doc:name="Set Valid Notification Request">
                <munit:payload value="#[MunitTools::getResourceAsString('sample-data/notification-request.json')]" mediaType="application/json" encoding="UTF-8"/>
                <munit:attributes value="#[{
                    headers: {
                        'client_id': p('secure::api.clientId'),
                        'client_secret': p('secure::api.clientSecret'),
                        'content-type': 'application/json'
                    },
                    method: 'POST',
                    requestPath: '/api/v1/notifications'
                }]"/>
                <munit:variables>
                    <munit:variable key="correlationId" value="#[uuid()]"/>
                </munit:variables>
            </munit:set-event>
            
            <!-- Call the implementation flow -->
            <flow-ref doc:name="Call POST Notifications Flow" name="post:\notifications:application\json:notification-system-api-config"/>
            
        </munit:execution>
        
    </munit:test>

    <!-- =========================================================
         Test: Notification Service Error - Connectivity Failure
         Verifies HTTP 500 when notification service is unavailable
         ========================================================= -->
    <munit:test name="notification-service-connectivity-error-test" 
                description="Test notification service connectivity error - HTTP 500"
                expectedErrorType="APP:NOTIFICATION_SERVICE_ERROR">
        
        <!-- Behavior: Mock services -->
        <munit:behavior>
            
            <!-- Mock Document Service to succeed -->
            <munit-tools:mock-when doc:name="Mock Document Service Success" processor="http:request">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Call Document Service" attributeName="doc:name"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:payload value="#[MunitTools::getResourceAsString('sample-data/document-service-response.json')]" mediaType="application/json" encoding="UTF-8"/>
                    <munit-tools:attributes value="#[{statusCode: 200}]"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
            <!-- Mock Notification Service to return error -->
            <munit-tools:mock-when doc:name="Mock Notification Service Error" processor="http:request">
                <munit-tools:with-attributes>
                    <munit-tools:with-attribute whereValue="Call Notification Service" attributeName="doc:name"/>
                </munit-tools:with-attributes>
                <munit-tools:then-return>
                    <munit-tools:error typeId="HTTP:CONNECTIVITY"/>
                </munit-tools:then-return>
            </munit-tools:mock-when>
            
        </munit:behavior>
        
        <!-- Execution -->
        <munit:execution>
            
            <!-- Set input event with valid request -->
            <munit:set-event doc:name="Set Valid Notification Request">
                <munit:payload value="#[MunitTools::getResourceAsString('sample-data/notification-request.json')]" mediaType="application/json" encoding="UTF-8"/>
                <munit:attributes value="#[{
                    headers: {
                        'client_id': p('secure::api.clientId'),
                        'client_secret': p('secure::api.clientSecret'),
                        'content-type': 'application/json'
                    },
                    method: 'POST',
                    requestPath: '/api/v1/notifications'
                }]"/>
                <munit:variables>
                    <munit:variable key="correlationId" value="#[uuid()]"/>
                </munit:variables>
            </munit:set-event>
            
            <!-- Call the implementation flow -->
            <flow-ref doc:name="Call POST Notifications Flow" name="post:\notifications:application\json:notification-system-api-config"/>
            
        </munit:execution>
        
    </munit:test>

</mule>
