<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- =========================================================
         Global Error Handler - Centralized Error Handling
         Handles all error types and maps to standard ErrorResponse
         ========================================================= -->
    <error-handler name="global-error-handler" doc:name="Global Error Handler">
        
        <!-- =========================================================
             Validation Errors - HTTP 400
             ========================================================= -->
        <on-error-propagate type="APP:VALIDATION_ERROR" 
                            doc:name="On Error Propagate - Validation" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Validation Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "VALIDATION_ERROR",
    errorMessage: error.description default "Request validation failed",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Validation Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Validation Error: " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             APIKit Bad Request Errors - HTTP 400
             ========================================================= -->
        <on-error-propagate type="APIKIT:BAD_REQUEST" 
                            doc:name="On Error Propagate - APIKit Bad Request" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Bad Request Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "BAD_REQUEST",
    errorMessage: error.description default "Invalid request format",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Bad Request Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Bad Request: " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             Authentication Errors - HTTP 401
             ========================================================= -->
        <on-error-propagate type="APP:UNAUTHORIZED" 
                            doc:name="On Error Propagate - Unauthorized" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Unauthorized Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "UNAUTHORIZED",
    errorMessage: "Invalid or missing client credentials",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[401]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Unauthorized Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Unauthorized access attempt"]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             Document Service Errors - HTTP 500
             ========================================================= -->
        <on-error-propagate type="APP:DOCUMENT_SERVICE_ERROR" 
                            doc:name="On Error Propagate - Document Service" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Document Service Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "DOCUMENT_SERVICE_ERROR",
    errorMessage: "Failed to generate policy document",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Document Service Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Document Service Error: " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             Notification Service Errors - HTTP 500
             ========================================================= -->
        <on-error-propagate type="APP:NOTIFICATION_SERVICE_ERROR" 
                            doc:name="On Error Propagate - Notification Service" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Notification Service Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "NOTIFICATION_SERVICE_ERROR",
    errorMessage: "Failed to send notification",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Notification Service Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Notification Service Error: " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             HTTP Connectivity Errors - HTTP 500
             ========================================================= -->
        <on-error-propagate type="HTTP:CONNECTIVITY, HTTP:TIMEOUT" 
                            doc:name="On Error Propagate - HTTP Connectivity" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Connectivity Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "DOWNSTREAM_SERVICE_ERROR",
    errorMessage: "Unable to connect to downstream service",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Connectivity Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Downstream Connectivity Error: " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

        <!-- =========================================================
             Unknown/Catch-All Errors - HTTP 500
             ========================================================= -->
        <on-error-propagate type="ANY" 
                            doc:name="On Error Propagate - Unknown" 
                            enableNotifications="true" 
                            logException="true">
            <ee:transform doc:name="Transform - Unknown Error Response">
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    errorCode: "INTERNAL_SERVER_ERROR",
    errorMessage: "An unexpected error occurred",
    correlationId: vars.correlationId default correlationId
}]]></ee:set-payload>
                </ee:message>
                <ee:variables>
                    <ee:set-variable variableName="httpStatus"><![CDATA[500]]></ee:set-variable>
                </ee:variables>
            </ee:transform>
            <logger level="ERROR" 
                    doc:name="Log Unknown Error" 
                    message='#["[" ++ (vars.correlationId default correlationId) ++ "] Unknown Error: " ++ (error.errorType.identifier default "UNKNOWN") ++ " - " ++ (error.description default "Unknown")]' 
                    category="${logging.category}"/>
        </on-error-propagate>

    </error-handler>

</mule>
